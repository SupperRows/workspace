<div class="layui-card">
    <div class="layui-card-body">
        <div class="layui-form toolbar">
            上架状态
            <select id="sale-state" lay-filter="sale-state" autocomplete="off">
                <option value="">-请选择-</option>
            </select>
            热销状态
            <div class="layui-input-inline">
                <select id="hot-state" lay-filter="hot-state" autocomplete="off">
                    <option value="">-请选择-</option>
                </select>
            </div>
            活动时间
            <div class="layui-input-inline">
                <input class="layui-input" id="date_time" type="text" autocomplete="off"
                       placeholder=" 开始 - 结束">
            </div>
            <div class="layui-inline">
                搜索
                <select id="goods-search-key">
                    <option value="">-请选择-</option>
                    <option value="goodsId">SKU</option>
                    <option value="goodsModel">型号</option>
                </select>&emsp;
                <div class="layui-input-inline">
                    <input id="goods-edit-value" class="layui-input search-input" type="text" placeholder="输入关键字"
                           autocomplete="off"/>
                </div>
                <button id="goods-btn-search" class="layui-btn icon-btn"><i class="layui-icon">&#xe615;</i>搜索
                </button>
                <button id="goods-btn-add" class=" layui-btn icon-btn layui-btn-warm"><i
                        class="layui-icon">&#xe654;</i>添加商品
                </button>
            </div>
        </div>


        <!-- 数据表格 -->
        <table class="layui-table" id="goods-table" lay-filter="goods-table"></table>
    </div>
</div>

<!-- 表格操作列 -->
<script type="text/html" id="goods-table-bar">
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">修改</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>

<!-- 表单弹窗 -->
<script type="text/html" id="goods-model">
    <form id="goods-form" lay-filter="goods-form" class="layui-form model-form">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">SKU</label>
                <div class="layui-input-block">
                    <input type="text" name="goodsId" id="goodsId" autocomplete="off"
                           placeholder="请输入SKU" class="layui-input" oninput="value=value.replace(/[^\d]/g,'')">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">商品型号</label>
                <div class="layui-input-block">
                    <input type="text" name="goodsModel" id="goodsModel" autocomplete="off"
                           placeholder="请输入商品型号" class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">图片链接</label>
            <div class="layui-input-block">
                <input type="text" name="goodsImg" id="goodsImg" autocomplete="off"
                       placeholder="请输入图片链接" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">页面价</label>
                <div class="layui-input-block">
                    <input type="text" name="pagePrice" id="pagePrice" autocomplete="off"
                           placeholder="请输入页面价" class="layui-input" oninput="value=value.replace(/[^\d]/g,'')">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">内购价</label>
                <div class="layui-input-block">
                    <input type="text" name="purchasePrice" id="purchasePrice" autocomplete="off"
                           placeholder="请输入内购价" class="layui-input" oninput="value=value.replace(/[^\d]/g,'')">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">所属分类</label>
                <div class="layui-input-inline" id="classfiy-select">
                    <select id="classfiyId" name="classfiyId" lay-search>
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">所属品牌</label>
                <div class="layui-input-inline" id="brands-select">
                    <select id="brandsId" name="brandsId" lay-search>
                        <option value=""></option>
                    </select>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">活动时间</label>
            <div class="layui-input-inline">
                <input class="layui-input" name="promotionTime" id="promotionTime" type="text"
                       placeholder="yyyy-MM-dd" autocomplete="off">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">是否上架</label>
                <div class="layui-input-block">
                    <input name="isSale" id="isSale" type="checkbox" lay-filter="isSale"
                           lay-skin="switch" lay-text="是|否">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">是否热销</label>
                <div class="layui-input-block">
                    <input name="isHot" id="isHot" type="checkbox" lay-filter="isHot"
                           lay-skin="switch" lay-text="是|否">
                </div>
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">商品介绍</label>
            <div class="layui-input-block">
					<textarea class="layui-textarea" name="goodsIntroduce" maxlength="250" id="goodsIntroduce"
                              placeholder="请输入内容，字数250字以内。 "></textarea>
            </div>
        </div>
    </form>
</script>

<script>
    layui.use(['form', 'table', 'util', 'config', 'admin', 'formSelects', 'laydate'], function () {
        var form = layui.form;
        var table = layui.table;
        var config = layui.config;
        var layer = layui.layer;
        var util = layui.util;
        var admin = layui.admin;
        var formSelects = layui.formSelects;
        var laydate = layui.laydate;

        //自定义背景色主题 - 非常实用
        laydate.render({
            elem: '#date_time',
            trigger: 'click',
            range: true,
            theme: '#1e9fff',
            done: function (value, date, endDate) {
                table.reload('goods-table', {where: {promotionTime: value}});
            }
        });
        //渲染下拉框
        select('api-user/dictdetail/list', '58f61a8e35ea44e58754b38a56eef8cd', '#sale-state')
        select('api-user/dictdetail/list', 'd4e44f720b28401bb6e416f7a981d1f3', '#hot-state')
        layui.form.render("select");
        //渲染表格
        layer.load(2);
        table.render({
            elem: '#goods-table',
            url: config.base_server + 'api-user/goods/list',
            where: {
                access_token: config.getToken().access_token
            },
            page: {first: '首页', last: '尾页'},
            cols: [[
                {type: 'numbers'},
                {field: 'goodsId', width: 140, title: 'SKU', align: 'center'},
                {field: 'goodsModel', width: 140, title: '商品型号', align: 'center',},
                {
                    field: 'goodsImg', width: 100, title: '商品图片', align: 'center',
                    templet: function (d) {
                        let res = '<a href="' + d.goodsImg + '" target="_blank" title="点击查看大图"><img width="30px" height="30px" src="' + d.goodsImg + '"/></a>'
                        return res;
                    }
                },
                {field: 'goodsIntroduce', width: 240, title: '商品介绍', align: 'center'},
                {field: 'purchasePrice', width: 100, title: '内购价', sort: true, align: 'center'},
                {field: 'pagePrice', width: 100, title: '页面价', sort: true, align: 'center'},
                {
                    field: 'isSale', width: 100, title: '是否上架', align: 'center',
                    templet: function (d) {
                        if (d.isSale == 1) {
                            return '<span class="layui-badge layui-bg-blue">上架中</span>';
                        } else {
                            return '<span class="layui-badge" style="background-color:#FFB90F;">已下架</span>';
                        }
                    }
                },
                {
                    field: 'isHot', width: 100, title: '是否热销', align: 'center',
                    templet: function (d) {
                        if (d.isHot == 1) {
                            return '<span class="layui-badge layui-bg-blue">热销中</span>';
                        } else {
                            return '<span class="layui-badge" style="background-color:#FFB90F;">普通</span>';
                        }
                    }
                },
                {
                    field: 'pageUrl', width: 140, title: '京东链接', align: 'center',
                    templet: function (d) {
                        let res = '<a href="' + d.pageUrl + '"  target="_blank" title="点此前往京东">' + d.pageUrl + '</a>'
                        return res;
                    }
                },
                {field: 'promotionTime', width: 180, title: '活动时间', sort: true, align: 'center'},
                {field: 'createTime', width: 180, sort: true, align: 'center', title: '创建时间'},
                {fixed: 'right', align: 'center', toolbar: '#goods-table-bar', title: '操作', width: 180}]
            ],
            done: function (res, curr, count) {
                layer.closeAll('loading');
            }
        });

        // 添加按钮点击事件
        $('#goods-btn-add').click(function () {
            doSave();
        });

        // 工具条点击事件
        table.on('tool(goods-table)', function (obj) {
            var data = obj.data;
            if (obj.event === 'edit') { //修改
                doUpdate(data);
            } else if (obj.event === 'del') { //删除
                doDelete(obj);
            }
        });

        //显示表单弹窗
        var showEditModel = function (data) {
            admin.putTempData('t_goods', data);
            var title = data ? '修改商品信息' : '添加商品信息';
            admin.popupCenter({
                title: title,
                path: 'pages/goods/goods_form.html',
                offset: 'auto',
                area: ['70%', '93%'],
                success: function () {
                    // 日期范围
                    laydate.render({
                        elem: '#promotionTime',
                        trigger: 'click'
                    });
                    layui.form.render();
                },
                finish: function () {
                    table.reload('goods-table', {});
                }
            });
        };

        // 搜索按钮点击事件
        $('#goods-btn-search').click(function () {
            var key = $('#goods-search-key').val();
            var value = $('#goods-edit-value').val();
            table.reload('goods-table', {where: {searchKey: key, searchValue: value}});
        });
        // 监听上架状态下拉框
        form.on('select(sale-state)', function (e) {
            var value = e.value;
            table.reload('goods-table', {where: {isSale: value}});
        });
        // 监听热销状态下拉框
        form.on('select(hot-state)', function (e) {
            var value = e.value;
            table.reload('goods-table', {where: {isHot: value}});
        });

        // 删除
        var doDelete = function (obj) {
            layer.confirm('确定要删除吗？', function (i) {
                layer.close(i);
                layer.load(2);
                admin.req('api-user/goods/delete/' + obj.data.id, {}, function (data) {
                    layer.closeAll('loading');
                    if (data.code == 0) {
                        layer.msg(data.msg, {icon: 1, time: 500});
                        obj.del();
                    } else {
                        layer.msg(data.msg, {icon: 2, time: 500});
                    }
                }, 'DELETE');
            });
        };
        //编辑
        var doUpdate = function (data) {
            layer.open({
                type: 1,
                area: ['60%'],
                title: ['编辑商品信息'],
                btn: ['保存', '取消'],
                shadeClose: true,
                btnAlign: 'c',
                shade: 0.5,
                content: $('#goods-model').html(),
                success: function (layero, index) {
                    // 获取所有商品分类
                    admin.req('api-user/classfiydetail/list', {}, function (data) {
                        if (0 == data.code) {
                            // 渲染多选下拉框
                            var classfiy = data.data;
                            $.each(classfiy, function () {
                                if (this.parentId != '0') {
                                    var optionClassfiy = $("<option></option>").append(this.classfiyName).attr(
                                        "value", this.classfiyId);
                                    optionClassfiy.appendTo("#classfiy-select select");
                                }
                            })
                        } else {
                            layer.msg('获取分类失败', {icon: 2, time: 500});
                        }
                    }, 'GET');
                    // 获取所有品牌
                    admin.req('api-user/brands/list', {}, function (data) {
                        layer.closeAll('loading');
                        if (0 == data.code) {
                            // 渲染多选下拉框
                            var brands = data.data;
                            $.each(brands, function () {
                                var optionBrands = $("<option></option>").append(this.brandsName).attr(
                                    "value", this.brandsId);
                                optionBrands.appendTo("#brands-select select");
                            })
                        } else {
                            layer.msg('获取分类失败', {icon: 2, time: 500});
                        }
                    }, 'GET');
                    // 日期范围
                    laydate.render({
                        elem: '#promotionTime',
                        trigger: 'click'
                    });
                    $("#goodsId").val(data.goodsId);
                    $("#goodsModel").val(data.goodsModel);
                    $("#goodsImg").val(data.goodsImg);
                    $("#pagePrice").val(data.pagePrice);
                    $("#classfiyId").val(data.classfiyId);
                    $("#brandsId").val(data.brandsId);
                    $("#purchasePrice").val(data.purchasePrice);
                    $("input[name='promotionTime']").val(data.promotionTime) + ' 00:00:00';
                    $("#goodsIntroduce").val(data.goodsIntroduce);
                    if (data.isSale == 0) {
                        $("#isSale").val(0).prop("checked", false)
                    } else if (data.isSale == 1) {
                        $("#isSale").val(1).prop("checked", true)
                    }
                    if (data.isHot == 0) {
                        $("#isHot").val(0).prop("checked", false)
                    } else if (data.isHot == 1) {
                        $("#isHot").val(1).prop("checked", true)
                    }
                    layui.form.render();
                    form.on('switch(isSale)', function (data) {
                        var checked = data.elem.checked;
                        if (checked == true) {
                            $("#isSale").val(1);
                        } else if (checked == false) {
                            $("#isSale").val(0);
                        }
                    })
                    form.on('switch(isHot)', function (data) {
                        var checked = data.elem.checked;
                        if (checked == true) {
                            $("#isHot").val(1);
                        } else if (checked == false) {
                            $("#isHot").val(0);
                        }
                    })
                },
                yes: function (index, layero) {
                    const goodsId = $("#goodsId").val();
                    const goodsIntroduce = $("#goodsIntroduce").val();
                    const pagePrice = $("#pagePrice").val();
                    const purchasePrice = $("#purchasePrice").val();
                    const goodsModel = $("#goodsModel").val();
                    const goodsImg = $("#goodsImg").val();
                    const pageUrl = "https://item.jd.com/" + goodsId + ".html";
                    var promotionTime = "";
                    if ($("input[name='promotionTime']").val() != '') {
                        promotionTime = $("input[name='promotionTime']").val() + ' 00:00:00';
                    }
                    const classfiyId = $("#classfiyId").val();
                    const brandsId = $("#brandsId").val();
                    const isSale = $("#isSale").val();
                    const isHot = $("#isHot").val();
                    const reqdata = {
                        id: data.id,
                        goodsId: goodsId,
                        goodsIntroduce: goodsIntroduce,
                        pagePrice: pagePrice,
                        purchasePrice: purchasePrice,
                        goodsModel: goodsModel,
                        goodsImg: goodsImg,
                        pageUrl: pageUrl,
                        promotionTime: promotionTime,
                        classfiyId: classfiyId,
                        brandsId: brandsId,
                        isSale: isSale,
                        isHot: isHot,
                    }
                    admin.req('api-user/goods/update', JSON.stringify(reqdata), function (res) {
                        if (res.code == 0) {
                            layer.alert(res.msg, {
                                icon: 1,
                                title: '提示'
                            }, function (i) {
                                layer.close(i);
                                layer.close(index);
                                $("#goods-form")[0].reset()
                            })
                            table.reload('goods-table', {
                                page: {
                                    curr: 0
                                }
                            })
                        } else {
                            layer.msg(res.msg, {
                                icon: 5
                            });
                        }
                    }, 'POST');
                }
            })
        }
        //添加
        var doSave = function () {
            layer.open({
                type: 1,
                title: '添加商品信息',
                shadeClose: true,
                area: ['60%'],
                btnAlign: 'c',
                content: $('#goods-model').html(),
                btn: ['确定', '取消'],
                success: function () {
                    // 获取所有商品分类
                    admin.req('api-user/classfiydetail/list', {}, function (data) {
                        if (0 == data.code) {
                            // 渲染多选下拉框
                            var classfiy = data.data;
                            $.each(classfiy, function () {
                                if (this.parentId != '0') {
                                    var optionClassfiy = $("<option></option>").append(this.classfiyName).attr(
                                        "value", this.classfiyId);
                                    optionClassfiy.appendTo("#classfiy-select select");
                                }
                            })
                        } else {
                            layer.msg('获取分类失败', {icon: 2, time: 500});
                        }
                    }, 'GET');
                    // 获取所有品牌
                    admin.req('api-user/brands/list', {}, function (data) {
                        layer.closeAll('loading');
                        if (0 == data.code) {
                            // 渲染多选下拉框
                            var brands = data.data;
                            $.each(brands, function () {
                                var optionBrands = $("<option></option>").append(this.brandsName).attr(
                                    "value", this.brandsId);
                                optionBrands.appendTo("#brands-select select");
                            })
                        } else {
                            layer.msg('获取分类失败', {icon: 2, time: 500});
                        }
                    }, 'GET');
                    $("#isSale").val(1)
                    if ($("#isSale").val() == 0) {
                        $("#isSale").val(0).prop("checked", false)
                    } else if ($("#isSale").val() == 1) {
                        $("#isSale").val(1).prop("checked", true)
                    }
                    form.on('switch(isSale1)', function (data) {
                        var checked = data.elem.checked;
                        if (checked == true) {
                            $("#isSale").val(1);
                        } else if (checked == false) {
                            $("#isSale").val(0);
                        }
                    })
                    $("#isHot").val(1)
                    if ($("#isHot").val() == 0) {
                        $("#isHot").val(0).prop("checked", false)
                    } else if ($("#isHot").val() == 1) {
                        $("#isHot").val(1).prop("checked", true)
                    }
                    form.on('switch(isHot1)', function (data) {
                        var checked = data.elem.checked;
                        if (checked == true) {
                            $("#isHot").val(1);
                        } else if (checked == false) {
                            $("#isHot").val(0);
                        }
                    })
                    // 日期范围
                    laydate.render({
                        elem: '#promotionTime',
                        trigger: 'click'
                    });
                    layui.form.render();
                },
                yes: function (index, layero) {
                    const goodsId = $("#goodsId").val();
                    const goodsIntroduce = $("#goodsIntroduce").val();
                    const pagePrice = $("#pagePrice").val();
                    const purchasePrice = $("#purchasePrice").val();
                    const goodsModel = $("#goodsModel").val();
                    const goodsImg = $("#goodsImg").val();
                    const pageUrl = "https://item.jd.com/" + goodsId + ".html";
                    const promotionTime = $("input[name='promotionTime']").val();
                    const classfiyId = $("#classfiyId").val();
                    const brandsId = $("#brandsId").val();
                    const isSale = $("#isSale").val();
                    const isHot = $("#isHot").val();
                    if(goodsId ==''){
                        layer.msg("请先输入SKU!", {});
                    }else if(goodsImg == ''){
                        layer.msg("请先输入商品图片链接!", {});
                    }else if(pagePrice == ''){
                        layer.msg("请先输入页面价!", {});
                    }else if(purchasePrice == ''){
                        layer.msg("请先输入活动价!", {});
                    }else if(classfiyId == ''){
                        layer.msg("请选择所属分类!", {});
                    }else if(brandsId == ''){
                        layer.msg("请选择所属品牌!", {});
                    }else {
                        var reqdata = {
                            goodsId: goodsId,
                            goodsIntroduce: goodsIntroduce,
                            pagePrice: pagePrice,
                            purchasePrice: purchasePrice,
                            goodsModel: goodsModel,
                            goodsImg: goodsImg,
                            pageUrl: pageUrl,
                            promotionTime: promotionTime,
                            classfiyId: classfiyId,
                            brandsId: brandsId,
                            isSale: isSale,
                            isHot: isHot,
                        }
                        admin.req('api-user/goods/save', JSON.stringify(reqdata), function (res) {
                            if (res.code == 0) {
                                layer.alert(res.msg, {
                                    icon: 1,
                                    title: '提示'
                                }, function (i) {
                                    layer.close(i);
                                    layer.close(index);
                                    $("#goods-form")[0].reset()
                                })
                                table.reload('goods-table', {
                                    page: {
                                        curr: 0
                                    }
                                })
                            } else {
                                layer.msg(res.msg, {
                                    icon: 5
                                });
                            }
                        }, 'PUT');
                    }
                }
            })
        }
    });
</script>